<!DOCTYPE html>
<html lang=de>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="BD-HDFS-NameNode和SecondaryNameNode主要内容 NN和2NN的工作机制 Fsimage和Edits解析 CheckPoint时间设置 NameNode 故障处理  1.1 NN和2NN的工作机制问题：元数据就是描述数据的数据，NameNode中的元数据相当于一本书的目录，可以找到DataNode中的块。那么NameNode中的元数据是存储在哪里的？ 首先，我们做个">
<meta property="og:type" content="article">
<meta property="og:title" content="BD-HDFS-NameNode和SecondaryNameNode">
<meta property="og:url" content="http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/index.html">
<meta property="og:site_name" content="MurasakiSeiFu">
<meta property="og:description" content="BD-HDFS-NameNode和SecondaryNameNode主要内容 NN和2NN的工作机制 Fsimage和Edits解析 CheckPoint时间设置 NameNode 故障处理  1.1 NN和2NN的工作机制问题：元数据就是描述数据的数据，NameNode中的元数据相当于一本书的目录，可以找到DataNode中的块。那么NameNode中的元数据是存储在哪里的？ 首先，我们做个">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7br5bnf2dj313a0u0wj5.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7br92hd3rj312y0u079u.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7breiswt0j310i0u00z4.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7brosqqh2j31ms0u0gu8.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7brvs9k5cj31ms0u0k1a.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7bs6nieb2j31mq0u0dqw.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7bscdx88kj31n00u0am2.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7bshj5vs1j31mx0u07h0.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7bsre61a8j31me0u0nbq.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7c4exas9xj31rk0u0gw4.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7c4kkqzb3j310w0ds40z.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7c4mbq6dhj317c06mmz0.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7c4oogh79j315g0nyk5r.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7c54dmyslj311a09ejvs.jpg">
<meta property="og:updated_time" content="2019-09-26T12:46:29.027Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="BD-HDFS-NameNode和SecondaryNameNode">
<meta name="twitter:description" content="BD-HDFS-NameNode和SecondaryNameNode主要内容 NN和2NN的工作机制 Fsimage和Edits解析 CheckPoint时间设置 NameNode 故障处理  1.1 NN和2NN的工作机制问题：元数据就是描述数据的数据，NameNode中的元数据相当于一本书的目录，可以找到DataNode中的块。那么NameNode中的元数据是存储在哪里的？ 首先，我们做个">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/006y8mN6ly1g7br5bnf2dj313a0u0wj5.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>BD-HDFS-NameNode和SecondaryNameNode</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="http://github.com/murasakiseifu">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2019/09/27/BD-HDFS-DataNode/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2019/09/25/BD-HDFS-HDFS的数据流读入/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&text=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&title=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&is_video=false&description=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BD-HDFS-NameNode和SecondaryNameNode&body=Check out this article: http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&title=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&title=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&title=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&title=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&name=BD-HDFS-NameNode和SecondaryNameNode&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&t=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BD-HDFS-NameNode和SecondaryNameNode"><span class="toc-number">1.</span> <span class="toc-text">BD-HDFS-NameNode和SecondaryNameNode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#主要内容"><span class="toc-number">1.1.</span> <span class="toc-text">主要内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-NN和2NN的工作机制"><span class="toc-number">1.2.</span> <span class="toc-text">1.1 NN和2NN的工作机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第一步"><span class="toc-number">1.2.1.</span> <span class="toc-text">第一步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二步"><span class="toc-number">1.2.2.</span> <span class="toc-text">第二步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三步"><span class="toc-number">1.2.3.</span> <span class="toc-text">第三步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第四步"><span class="toc-number">1.2.4.</span> <span class="toc-text">第四步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第五步"><span class="toc-number">1.2.5.</span> <span class="toc-text">第五步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第六步"><span class="toc-number">1.2.6.</span> <span class="toc-text">第六步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第七步"><span class="toc-number">1.2.7.</span> <span class="toc-text">第七步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第八步"><span class="toc-number">1.2.8.</span> <span class="toc-text">第八步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第九步"><span class="toc-number">1.2.9.</span> <span class="toc-text">第九步</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Fsimage和Edits解析"><span class="toc-number">1.3.</span> <span class="toc-text">2 Fsimage和Edits解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Fsimage和Edits概念"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 Fsimage和Edits概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-oiv查看Fsimage文件"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 oiv查看Fsimage文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-oev查看Edits文件"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 oev查看Edits文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-CheckPoint时间设置"><span class="toc-number">1.4.</span> <span class="toc-text">3 CheckPoint时间设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-NameNode故障处理"><span class="toc-number">1.5.</span> <span class="toc-text">4 NameNode故障处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-将SecondaryNameNode中数据拷贝到NameNode存储数据的目录"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 将SecondaryNameNode中数据拷贝到NameNode存储数据的目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-使用-importCheckpoint选项启动NameNode守护进程，从而将SecondaryNameNode中数据拷贝到NameNode目录中。"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 使用-importCheckpoint选项启动NameNode守护进程，从而将SecondaryNameNode中数据拷贝到NameNode目录中。</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        BD-HDFS-NameNode和SecondaryNameNode
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">MurasakiSeiFu.</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-09-26T01:27:36.000Z" itemprop="datePublished">2019-09-26</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Hadoop-HDFS/">Hadoop-HDFS</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <meta name="referrer" content="no-referrer">

<h1 id="BD-HDFS-NameNode和SecondaryNameNode"><a href="#BD-HDFS-NameNode和SecondaryNameNode" class="headerlink" title="BD-HDFS-NameNode和SecondaryNameNode"></a>BD-HDFS-NameNode和SecondaryNameNode</h1><h2 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h2><ol>
<li>NN和2NN的工作机制</li>
<li>Fsimage和Edits解析</li>
<li>CheckPoint时间设置</li>
<li>NameNode 故障处理</li>
</ol>
<h2 id="1-1-NN和2NN的工作机制"><a href="#1-1-NN和2NN的工作机制" class="headerlink" title="1.1 NN和2NN的工作机制"></a>1.1 NN和2NN的工作机制</h2><p>问题：元数据就是描述数据的数据，NameNode中的元数据相当于一本书的目录，可以找到DataNode中的块。那么NameNode中的元数据是存储在哪里的？</p>
<p>首先，我们做个假设，如果元数据存储在NameNode节点的磁盘中，因为经常需要进行随机访问，还有响应客户请求，必然是效率过低。因此，元数据需要存放在内存中。但如果只存在内存中，一旦断电，元数据丢失，整个集群就无法工作了。<font color="red">因此产生了在磁盘中备份元数据的FsImage。</font></p>
<p>这样又会带来新的问题，当在内存中的元数据更新时，如果同时更新FsImage，就会导致效率过低，但如果不更新，就会发生一致性问题，一旦NameNode节点断电，就会产生数据丢失。<font color="red">因此，引入Edits文件(只进行追加操作，效率很高)。每当元数据有更新或者添加元数据时，修改内存中的元数据并追加到Edits中。</font>这样，一旦NameNode节点断电，可以通过FsImage和Edits的合并，合成元数据。</p>
<p>但是，如果长时间添加数据到Edits中，会导致该文件数据过大，效率降低，而且一旦断电，恢复元数据需要的时间过长。因此，需要定期进行FsImage和Edits的合并，如果这个操作由NameNode节点完成，又会效率过低。<font color="red">因此，引入一个新的节点SecondaryNamenode，专门用于FsImage和Edits的合并。</font></p>
<p>这么看确实很难理解，我们结合NN和2NN的工作机制，就很清晰了。</p>
<h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7br5bnf2dj313a0u0wj5.jpg" alt=""></p>
<p>当我们集群首次启动的时候，NN会加载FsImage，因为FsImage加载起来比较快（相当于Redis的RDB快照），我们先不管edits_inprogress_001。</p>
<h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7br92hd3rj312y0u079u.jpg" alt=""></p>
<p>加载完了以后就可以正常工作了。这时，来了一条元数据的增删改请求。</p>
<h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7breiswt0j310i0u00z4.jpg" alt=""></p>
<p>此时面临一个选择：我们是先更新内存再更新文件？还是先更新文件再更新内存？因为HDFS对数据安全性较高，所以会选择先更新文件再更新内存，当文件更新完了就会通知客户端，如果此时断点，也不会丢失更新的部分。因此，将更新的操作日志记录在edits_inprogress_001中（3—&gt;4）</p>
<h3 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7brosqqh2j31ms0u0gu8.jpg" alt=""></p>
<p>随着edits_inprogress_001记录的操作越来越多，使得这个文件越来越大，需要合并到，这时候2NN就登场了。首先，2NN每隔一段时间就会问NN一次，需不需要合并，注意并不是这个间隔时间到了之后一定要合并，而是进行询问是否需要合并。</p>
<h3 id="第五步"><a href="#第五步" class="headerlink" title="第五步"></a>第五步</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7brvs9k5cj31ms0u0k1a.jpg" alt=""></p>
<p>NN是否会同意进行合并，有两种出发条件：第一种，距离上一次合并，已经到达一定的时间了，第二种，Edits中的数据满了。这里我们先不管，后面会说。如果这两个条件触发了其中任何一个，都会发生合并，如果NN回答Yes，那么2NN将发起请求合并</p>
<p>大家还记得当时NameNode是怎么加载数据的？先加载了一个FsImage，类似我们内存的存档或者一个进度，加载完了之后，我们又往NameNode的内存写了很多数据，写的数据又记录在edits_inprogress_001（edits.log）中，现在我们要进行合并，到底要把那部分发送给2NN呢？edits.log + FsImage，因为我们要完全还原我们的内存镜像，就是FsImage（存档）+ edits.log（存档之后的变动操作）。具体NN的做法如下图：</p>
<h3 id="第六步"><a href="#第六步" class="headerlink" title="第六步"></a>第六步</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7bs6nieb2j31mq0u0dqw.jpg" alt=""></p>
<p>首先，NN把我们正在编辑的文件edits_inprgress_001改个名字为edits_001，然后新建一个新的文件，取名为edits_inprogress_002，新的文件用来写新的操作记录，为了不让持久化操作影响新的数据更新。</p>
<h3 id="第七步"><a href="#第七步" class="headerlink" title="第七步"></a>第七步</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7bscdx88kj31n00u0am2.jpg" alt=""></p>
<p>然后NN将edits_001和fsimage拷贝到2NN（fsimage + fsimage之后发生的操作）。</p>
<h3 id="第八步"><a href="#第八步" class="headerlink" title="第八步"></a>第八步</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7bshj5vs1j31mx0u07h0.jpg" alt=""></p>
<p>接下来2NN开始进行合并，其实2NN合并的过程和NN启动的过程非常像，第一步，先加载fsimage，这个相当于NN的存档，第二步，加载完了之后再加载edits_001中的操作。此时2NN的内存状态为，edits_001这些数据截止的时候（我们稍后再说）。</p>
<h3 id="第九步"><a href="#第九步" class="headerlink" title="第九步"></a>第九步</h3><p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7bsre61a8j31me0u0nbq.jpg" alt=""></p>
<p>2NN合并完成后生成新的fsimage.chkpoint，并拷贝到NN。NameNode将fsimage.chkpoint重新命名成fsimage。这样，一次持久化的操作就完成了。</p>
<p>Fsimage就相当于内存的存档，记录了内存的状态，edits就相当于存档之后和下一次存档之间，记录未录入存档的操作的小纸条。当我们下次启动开始读档的时候，会将小纸条上的操作一条条的执行一遍。2NN就像NN的秘书一样，NN将对于存档读档的管理交给2NN，由2NN来执行小纸条上的操作，并记录到新存档中，再将新存档交给NN。</p>
<p><strong>精炼详解（配合着图片流程，同时回答了图流程中遗留的问题）：</strong></p>
<ol>
<li><p>NameNode启动时，先滚动Edits并生成一个空的edits.inprogress，然后加载Edits和Fsimage到内存中，此时NameNode内存就持有最新的元数据信息。</p>
</li>
<li><p>Client开始对NameNode发送元数据的增删改的请求，这些请求的操作首先会被记录到edits.inprogress中（查询元数据的操作不会被记录在Edits中，因为查询操作不会更改元数据信息），如果此时NameNode挂掉，重启后会从Edits中读取元数据的信息。然后，NameNode会在内存中执行元数据的增删改的操作。</p>
</li>
<li><p>由于Edits中记录的操作会越来越多，Edits文件会越来越大，导致NameNode在启动加载Edits时会很慢，所以需要对Edits和Fsimage进行合并（所谓合并，就是将Edits和Fsimage加载到内存中，照着Edits中的操作一步步执行，最终形成新的Fsimage）。SecondaryNameNode的作用就是帮助NameNode进行Edits和Fsimage的合并工作。</p>
</li>
<li><p>SecondaryNameNode首先会询问NameNode是否需要CheckPoint（触发CheckPoint需要满足两个条件中的任意一个，定时时间到和Edits中数据写满了）。直接带回NameNode是否检查结果。</p>
</li>
<li><p>SecondaryNameNode执行CheckPoint操作，首先会让NameNode滚动Edits并生成一个空的edits.inprogress，滚动Edits的目的是给Edits打个标记，以后所有新的操作都写入edits.inprogress。</p>
</li>
<li><p>其他未合并的Edits和Fsimage会拷贝到SecondaryNameNode的本地，然后将拷贝的Edits和Fsimage加载到内存中进行合并，生成fsimage.chkpoint。</p>
</li>
<li><p>然后将fsimage.chkpoint拷贝给NameNode。</p>
</li>
<li><p>重命名为Fsimage后替换掉原来的Fsimage。NameNode在启动时就只需要加载之前未合并的Edits和Fsimage即可，因为合并过的Edits中的元数据信息已经被记录在Fsimage中。</p>
</li>
</ol>
<p><strong><em>我们可以发现，2NN与NN之间差了一个edits_inprogress_002，所以当NN挂了的时候，2NN不能盲目的顶上去。</em></strong></p>
<h2 id="2-Fsimage和Edits解析"><a href="#2-Fsimage和Edits解析" class="headerlink" title="2 Fsimage和Edits解析"></a>2 Fsimage和Edits解析</h2><h3 id="2-1-Fsimage和Edits概念"><a href="#2-1-Fsimage和Edits概念" class="headerlink" title="2.1 Fsimage和Edits概念"></a>2.1 Fsimage和Edits概念</h3><ol>
<li><p>Fsimage文件：HDFS文件系统元数据的一个永久性的检查点，其中包含HDFS文件系统的所有目录和文件inode的序列化信息。</p>
</li>
<li><p>Edits文件：存放HDFS文件系统的所有更新操作的路径，文件系统客户端执行的所有写操作首先会被记录到Edits文件中。</p>
</li>
<li><p>seen_txid文件保存的是一个数字，就是最后一个edits_的数字</p>
</li>
<li><p>每次NameNode启动的时候都会将Fsimage文件读入内存，加载Edits里面的更新操作，保证内存中的元数据信息是最新的、同步的，可以看成NameNode启动的时候就将Fsimage和Edits文件进行了合并。</p>
</li>
</ol>
<p>我们并不能直接通过cat命令查看Fsimage和Edits文件，因为Fsimage是NN的元数据序列化以后的文件，所以我们需要使用HDFS提供的命令。</p>
<h3 id="2-2-oiv查看Fsimage文件"><a href="#2-2-oiv查看Fsimage文件" class="headerlink" title="2.2 oiv查看Fsimage文件"></a>2.2 oiv查看Fsimage文件</h3><ol>
<li>查看oiv和oev命令</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">oiv                  apply the offline fsimage viewer to an fsimage</span><br><span class="line">oiv_legacy           apply the offline fsimage viewer to an legacy fsimage</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>基本语法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[fzz001@hadoop001 current]$ hdfs oiv</span><br><span class="line">Usage: bin/hdfs oiv [OPTIONS] -i INPUTFILE -o OUTPUTFILE</span><br><span class="line"></span><br><span class="line">hdfs oiv -p 文件类型 -i镜像文件 -o 转换后文件输出路径</span><br><span class="line"></span><br><span class="line">-p,--processor &lt;arg&gt;   Select which type of processor to apply</span><br><span class="line">                       against image file. (XML|FileDistribution|Web|Delimited)</span><br><span class="line">                       (Web by default)</span><br><span class="line">选择要应用于文件的处理器类型，一般我们都选择XML。</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>这里我们转一下。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[fzz001@hadoop001 current]$ hdfs oiv -p XML -i fsimage_0000000000000000441 -o fsimage.xml</span><br><span class="line">[fzz001@hadoop001 current]$ cat fsimage.xml</span><br></pre></td></tr></table></figure>
<p>我们可以把xml文件粘贴到idea里格式化一下，会好看很多。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">inode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>16386<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>DIRECTORY<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>wcinput<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mtime</span>&gt;</span>1565909468032<span class="tag">&lt;/<span class="name">mtime</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span>&gt;</span>fzz001:supergroup:rwxr-xr-x<span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nsquota</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">nsquota</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dsquota</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">dsquota</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">inode</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">inode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>16387<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>FILE<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>wc.input<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replication</span>&gt;</span>3<span class="tag">&lt;/<span class="name">replication</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mtime</span>&gt;</span>1565909468006<span class="tag">&lt;/<span class="name">mtime</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">atime</span>&gt;</span>1565909466949<span class="tag">&lt;/<span class="name">atime</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">perferredBlockSize</span>&gt;</span>134217728<span class="tag">&lt;/<span class="name">perferredBlockSize</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span>&gt;</span>fzz001:supergroup:rw-r--r--<span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">blocks</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">block</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>1073741825<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">genstamp</span>&gt;</span>1001<span class="tag">&lt;/<span class="name">genstamp</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">numBytes</span>&gt;</span>48<span class="tag">&lt;/<span class="name">numBytes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">blocks</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">inode</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到有文件类型（DIRECTORY）、文件名称（wcinput）、时间戳（1565909468032）、权限、副本数量（replication）、块大小（perferredBlockSize）、块列表（blocks）、单块的ID等等，每一个inode都是一个元数据信息。</p>
<p><strong><font color="red">但我们发现，这里其实并没有记录块所在的DataNode的信息？</font></strong><br>这里简单说一下，因为在集群启动后，要求DataNode上报数据块信息，并间隔一段时间后再次上报，后面的安全模式会细讲。</p>
<h3 id="2-3-oev查看Edits文件"><a href="#2-3-oev查看Edits文件" class="headerlink" title="2.3 oev查看Edits文件"></a>2.3 oev查看Edits文件</h3><ol>
<li>基本语法和oiv一样</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hdfs oev -p 文件类型 -i编辑日志 -o 转换后文件输出路径</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>同样，我们也转一下。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[fzz001@hadoop001 current]$ hdfs oev -p XML -i edits_0000000000000000110-0000000000000000210 -o edits.xml</span><br></pre></td></tr></table></figure>
<p>我们可以把xml文件粘贴到idea里格式化一下，会好看很多。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RECORD</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">OPCODE</span>&gt;</span>OP_ADD<span class="tag">&lt;/<span class="name">OPCODE</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">DATA</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">TXID</span>&gt;</span>130<span class="tag">&lt;/<span class="name">TXID</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">LENGTH</span>&gt;</span>0<span class="tag">&lt;/<span class="name">LENGTH</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">INODEID</span>&gt;</span>16407<span class="tag">&lt;/<span class="name">INODEID</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">PATH</span>&gt;</span>/hello7.txt<span class="tag">&lt;/<span class="name">PATH</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">REPLICATION</span>&gt;</span>2<span class="tag">&lt;/<span class="name">REPLICATION</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">MTIME</span>&gt;</span>1512943607866<span class="tag">&lt;/<span class="name">MTIME</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">ATIME</span>&gt;</span>1512943607866<span class="tag">&lt;/<span class="name">ATIME</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BLOCKSIZE</span>&gt;</span>134217728<span class="tag">&lt;/<span class="name">BLOCKSIZE</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">CLIENT_NAME</span>&gt;</span>DFSClient_NONMAPREDUCE_-1544295051_1<span class="tag">&lt;/<span class="name">CLIENT_NAME</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">CLIENT_MACHINE</span>&gt;</span>172.16.239.100<span class="tag">&lt;/<span class="name">CLIENT_MACHINE</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">OVERWRITE</span>&gt;</span>true<span class="tag">&lt;/<span class="name">OVERWRITE</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">PERMISSION_STATUS</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">USERNAME</span>&gt;</span>fzz001<span class="tag">&lt;/<span class="name">USERNAME</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">GROUPNAME</span>&gt;</span>supergroup<span class="tag">&lt;/<span class="name">GROUPNAME</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">MODE</span>&gt;</span>420<span class="tag">&lt;/<span class="name">MODE</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">PERMISSION_STATUS</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">RPC_CLIENTID</span>&gt;</span>908eafd4-9aec-4288-96f1-e8011d181561<span class="tag">&lt;/<span class="name">RPC_CLIENTID</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">RPC_CALLID</span>&gt;</span>0<span class="tag">&lt;/<span class="name">RPC_CALLID</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">DATA</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RECORD</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到TXID是自增的，就是名字上110~210之间的，也就是操作的序号。<br>依然是记录了元数据信息，但是这些都还是没有写的数据。</p>
<ul>
<li>OPCODE：一个添加操作</li>
<li>PATH：文件路径</li>
<li>REPLICATION：副本数量。</li>
<li>CLIENT_NAME：客户端名字</li>
<li>CLIENT_MACHINE：客户端的IP.</li>
<li>PERMISSION_STATUS：权限信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;RECORD&gt;</span><br><span class="line">	&lt;OPCODE&gt;OP_ALLOCATE_BLOCK_ID&lt;/OPCODE&gt;</span><br><span class="line">	&lt;DATA&gt;</span><br><span class="line">		&lt;TXID&gt;131&lt;/TXID&gt;</span><br><span class="line">		&lt;BLOCK_ID&gt;1073741839&lt;/BLOCK_ID&gt;</span><br><span class="line">	&lt;/DATA&gt;</span><br><span class="line">&lt;/RECORD&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>OP_ALLOCATE_BLOCK_ID：为文件分配块Id，相当于返回的DN地址</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;RECORD&gt;</span><br><span class="line">	&lt;OPCODE&gt;OP_SET_GENSTAMP_V2&lt;/OPCODE&gt;</span><br><span class="line">	&lt;DATA&gt;</span><br><span class="line">		&lt;TXID&gt;132&lt;/TXID&gt;</span><br><span class="line">		&lt;GENSTAMPV2&gt;1016&lt;/GENSTAMPV2&gt;</span><br><span class="line">	&lt;/DATA&gt;</span><br><span class="line">&lt;/RECORD&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>OP_SET_GENSTAMP_V2：申请了一个时间戳</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;RECORD&gt;</span><br><span class="line">		&lt;OPCODE&gt;OP_ADD_BLOCK&lt;/OPCODE&gt;</span><br><span class="line">		&lt;DATA&gt;</span><br><span class="line">			&lt;TXID&gt;133&lt;/TXID&gt;</span><br><span class="line">			&lt;PATH&gt;/hello7.txt&lt;/PATH&gt;</span><br><span class="line">			&lt;BLOCK&gt;</span><br><span class="line">				&lt;BLOCK_ID&gt;1073741839&lt;/BLOCK_ID&gt;</span><br><span class="line">				&lt;NUM_BYTES&gt;0&lt;/NUM_BYTES&gt;</span><br><span class="line">				&lt;GENSTAMP&gt;1016&lt;/GENSTAMP&gt;</span><br><span class="line">			&lt;/BLOCK&gt;</span><br><span class="line">			&lt;RPC_CLIENTID&gt;&lt;/RPC_CLIENTID&gt;</span><br><span class="line">			&lt;RPC_CALLID&gt;-2&lt;/RPC_CALLID&gt;</span><br><span class="line">		&lt;/DATA&gt;</span><br><span class="line">	&lt;/RECORD&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>OP_ADD_BLOCK：添加块，也就说数据已经写完，把块的信息添加到元数据里面。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;RECORD&gt;</span><br><span class="line">		&lt;OPCODE&gt;OP_CLOSE&lt;/OPCODE&gt;</span><br><span class="line">		&lt;DATA&gt;</span><br><span class="line">			&lt;TXID&gt;134&lt;/TXID&gt;</span><br><span class="line">			&lt;LENGTH&gt;0&lt;/LENGTH&gt;</span><br><span class="line">			&lt;INODEID&gt;0&lt;/INODEID&gt;</span><br><span class="line">			&lt;PATH&gt;/hello7.txt&lt;/PATH&gt;</span><br><span class="line">			&lt;REPLICATION&gt;2&lt;/REPLICATION&gt;</span><br><span class="line">			&lt;MTIME&gt;1512943608761&lt;/MTIME&gt;</span><br><span class="line">			&lt;ATIME&gt;1512943607866&lt;/ATIME&gt;</span><br><span class="line">			&lt;BLOCKSIZE&gt;134217728&lt;/BLOCKSIZE&gt;</span><br><span class="line">			&lt;CLIENT_NAME&gt;&lt;/CLIENT_NAME&gt;</span><br><span class="line">			&lt;CLIENT_MACHINE&gt;&lt;/CLIENT_MACHINE&gt;</span><br><span class="line">			&lt;OVERWRITE&gt;false&lt;/OVERWRITE&gt;</span><br><span class="line">			&lt;BLOCK&gt;</span><br><span class="line">				&lt;BLOCK_ID&gt;1073741839&lt;/BLOCK_ID&gt;</span><br><span class="line">				&lt;NUM_BYTES&gt;25&lt;/NUM_BYTES&gt;</span><br><span class="line">				&lt;GENSTAMP&gt;1016&lt;/GENSTAMP&gt;</span><br><span class="line">			&lt;/BLOCK&gt;</span><br><span class="line">			&lt;PERMISSION_STATUS&gt;</span><br><span class="line">				&lt;USERNAME&gt;atguigu&lt;/USERNAME&gt;</span><br><span class="line">				&lt;GROUPNAME&gt;supergroup&lt;/GROUPNAME&gt;</span><br><span class="line">				&lt;MODE&gt;420&lt;/MODE&gt;</span><br><span class="line">			&lt;/PERMISSION_STATUS&gt;</span><br><span class="line">		&lt;/DATA&gt;</span><br><span class="line">	&lt;/RECORD&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>OP_CLOSE：关闭流。</li>
</ul>
<p><strong><font color="red">思考：NameNode如何确定下次开机启动的时候合并哪些Edits？</font></strong><br>我们fsimage后面有个编号，说明这个编号以前的edits都已经合并了，合并接下来的就可以了。</p>
<h2 id="3-CheckPoint时间设置"><a href="#3-CheckPoint时间设置" class="headerlink" title="3 CheckPoint时间设置"></a>3 CheckPoint时间设置</h2><ol>
<li>通常情况下，2NN每隔一个小时触发一次合并。</li>
</ol>
<p><strong><em>hdfs-default.xml</em></strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;dfs.namenode.checkpoint.period&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;3600&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>一分钟检查一次操作次数，当操作次数达到1百万时，SecondaryNameNode执行一次。</li>
</ol>
<p><strong><em>hdfs-default.xml</em></strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;dfs.namenode.checkpoint.txns&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;1000000&lt;/value&gt;</span><br><span class="line">&lt;description&gt;操作动作次数&lt;/description&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;dfs.namenode.checkpoint.check.period&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;60&lt;/value&gt;</span><br><span class="line">&lt;description&gt; 1分钟检查一次操作次数&lt;/description&gt;</span><br><span class="line">&lt;/property &gt;</span><br></pre></td></tr></table></figure>
<p>我们上传一个文件，肯定不是一次操作，比如我们上传1KB的文件和上传1GB的文件所进行操作数量肯定不一样。<br>在上面中我们提到CheckPoint出发有两个条件，其实还有第三个：每次NN刚刚启动的时候，也会进行一次CheckPoint（合并）。</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7c4exas9xj31rk0u0gw4.jpg" alt=""></p>
<p>我们可以很清楚的看到，在集群启动时候，执行三个操作：加载fsimage、加载edits.log、Saving checkpoint。具体在集群上怎么呈现的呢？</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7c4kkqzb3j310w0ds40z.jpg" alt=""></p>
<p>我们可以看到我们的分布式集群中，hadoop001启动NameNode。</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7c4mbq6dhj317c06mmz0.jpg" alt=""></p>
<p>进入到name文件夹下，可以看到current文件夹和in_use.lock，in_use.lock表示这个NameNode正在执行，有这个锁就表示别的人不能动这个元数据了。我们进入到current文件夹。</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7c4oogh79j315g0nyk5r.jpg" alt=""></p>
<p>这就是我们元数据整体存在的位置。edits_0000000000000006670-0000000000000006671 意思为记录了我们第6670到第6671次操作。因为我设置的是一分钟间隔，所以可以看到每次记录都是间隔1分钟。edits_inprogress_0000000000000013725 为我们新写的inprogress。fsimage之所以有两个，因为fsimage也会越来越多，所以它只会保留最新的和第二新的，剩下都被删了，edits永远都不会被删。</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7c54dmyslj311a09ejvs.jpg" alt=""></p>
<p>seen_txid 记录着我们现在正在记录操作的edits.inprogress编号。</p>
<h2 id="4-NameNode故障处理"><a href="#4-NameNode故障处理" class="headerlink" title="4 NameNode故障处理"></a>4 NameNode故障处理</h2><p>NameNode故障后，可以采用两种方法恢复数据。</p>
<h3 id="4-1-将SecondaryNameNode中数据拷贝到NameNode存储数据的目录"><a href="#4-1-将SecondaryNameNode中数据拷贝到NameNode存储数据的目录" class="headerlink" title="4.1 将SecondaryNameNode中数据拷贝到NameNode存储数据的目录"></a>4.1 将SecondaryNameNode中数据拷贝到NameNode存储数据的目录</h3><ol>
<li><p>kill -9 NameNode进程</p>
</li>
<li><p>删除NameNode存储的数据（/opt/module/hadoop-2.7.2/data/tmp/dfs/name）</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[fzz001@hadoop001 hadoop-2.7.2]$ rm -rf /opt/module/hadoop-2.7.2/data/tmp/dfs/name/*</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>拷贝SecondaryNameNode中数据到原NameNode存储数据目录</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[fzz001@hadoop001 dfs]$ scp -r atguigu@hadoop104:/opt/module/hadoop-2.7.2/data/tmp/dfs/namesecondary/* ./name/</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>重新启动NameNode</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[fzz001@hadoop001 hadoop-2.7.2]$ sbin/hadoop-daemon.sh start namenode</span><br></pre></td></tr></table></figure>
<h3 id="4-2-使用-importCheckpoint选项启动NameNode守护进程，从而将SecondaryNameNode中数据拷贝到NameNode目录中。"><a href="#4-2-使用-importCheckpoint选项启动NameNode守护进程，从而将SecondaryNameNode中数据拷贝到NameNode目录中。" class="headerlink" title="4.2 使用-importCheckpoint选项启动NameNode守护进程，从而将SecondaryNameNode中数据拷贝到NameNode目录中。"></a>4.2 使用-importCheckpoint选项启动NameNode守护进程，从而将SecondaryNameNode中数据拷贝到NameNode目录中。</h3><ol>
<li>修改hdfs-site.xml</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;dfs.namenode.checkpoint.period&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;120&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;/opt/module/hadoop-2.7.2/data/tmp/dfs/name&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>kill -9 NameNode进程</p>
</li>
<li><p>删除NameNode存储的数据（/opt/module/hadoop-2.7.2/data/tmp/dfs/name）</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[fzz001@hadoop002 hadoop-2.7.2]$ rm -rf /opt/module/hadoop-2.7.2/data/tmp/dfs/name/*</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>如果SecondaryNameNode不和NameNode在一个主机节点上，需要将SecondaryNameNode存储数据的目录拷贝到 NameNode存储数据的平级目录，并删除in_use.lock文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[fzz001@hadoop002 dfs]$ scp -r atguigu@hadoop104:/opt/module/hadoop-2.7.2/data/tmp/dfs/namesecondary ./</span><br><span class="line"></span><br><span class="line">[fzz001@hadoop002 namesecondary]$ rm -rf in_use.lock</span><br><span class="line"></span><br><span class="line">[fzz001@hadoop002 dfs]$ pwd</span><br><span class="line">/opt/module/hadoop-2.7.2/data/tmp/dfs</span><br><span class="line"></span><br><span class="line">[fzz001@hadoop002 dfs]$ ls</span><br><span class="line">data  name  namesecondary</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>导入检查点数据（等待一会ctrl+c结束掉）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[fzz001@hadoop002 hadoop-2.7.2]$ bin/hdfs namenode -importCheckpoint</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>启动NameNode</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[fzz001@hadoop002 hadoop-2.7.2]$ sbin/hadoop-daemon.sh start namenode</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="http://github.com/murasakiseifu">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BD-HDFS-NameNode和SecondaryNameNode"><span class="toc-number">1.</span> <span class="toc-text">BD-HDFS-NameNode和SecondaryNameNode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#主要内容"><span class="toc-number">1.1.</span> <span class="toc-text">主要内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-NN和2NN的工作机制"><span class="toc-number">1.2.</span> <span class="toc-text">1.1 NN和2NN的工作机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第一步"><span class="toc-number">1.2.1.</span> <span class="toc-text">第一步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二步"><span class="toc-number">1.2.2.</span> <span class="toc-text">第二步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三步"><span class="toc-number">1.2.3.</span> <span class="toc-text">第三步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第四步"><span class="toc-number">1.2.4.</span> <span class="toc-text">第四步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第五步"><span class="toc-number">1.2.5.</span> <span class="toc-text">第五步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第六步"><span class="toc-number">1.2.6.</span> <span class="toc-text">第六步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第七步"><span class="toc-number">1.2.7.</span> <span class="toc-text">第七步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第八步"><span class="toc-number">1.2.8.</span> <span class="toc-text">第八步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第九步"><span class="toc-number">1.2.9.</span> <span class="toc-text">第九步</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Fsimage和Edits解析"><span class="toc-number">1.3.</span> <span class="toc-text">2 Fsimage和Edits解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Fsimage和Edits概念"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 Fsimage和Edits概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-oiv查看Fsimage文件"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 oiv查看Fsimage文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-oev查看Edits文件"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 oev查看Edits文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-CheckPoint时间设置"><span class="toc-number">1.4.</span> <span class="toc-text">3 CheckPoint时间设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-NameNode故障处理"><span class="toc-number">1.5.</span> <span class="toc-text">4 NameNode故障处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-将SecondaryNameNode中数据拷贝到NameNode存储数据的目录"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 将SecondaryNameNode中数据拷贝到NameNode存储数据的目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-使用-importCheckpoint选项启动NameNode守护进程，从而将SecondaryNameNode中数据拷贝到NameNode目录中。"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 使用-importCheckpoint选项启动NameNode守护进程，从而将SecondaryNameNode中数据拷贝到NameNode目录中。</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&text=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&title=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&is_video=false&description=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BD-HDFS-NameNode和SecondaryNameNode&body=Check out this article: http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&title=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&title=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&title=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&title=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&name=BD-HDFS-NameNode和SecondaryNameNode&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://ilovenorth.cn/2019/09/26/BD-HDFS-NameNode和SecondaryNameNode/&t=BD-HDFS-NameNode和SecondaryNameNode"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2022
    MurasakiSeiFu.
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="http://github.com/murasakiseifu">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
